<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Manage Orders - MS MART Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <style>
    :root { --primary: #0a8; --dark: #111; --gray: #f4f7f9; --danger: #e74c3c; }
    body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--gray); padding-top: 70px; }
    
    /* HEADER */
    .header { 
      background: var(--dark); color: #fff; padding: 15px; 
      display: flex; align-items: center; justify-content: space-between;
      position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
    }
    .back-btn { color: white; text-decoration: none; font-size: 18px; }

    /* MAIN CONTAINER */
    .container { padding: 20px; max-width: 1000px; margin: 0 auto; }
    .page-title { margin-bottom: 20px; border-left: 5px solid var(--primary); padding-left: 15px; }

    /* ORDER CARD */
    .order-card {
      background: white; border-radius: 12px; padding: 20px; margin-bottom: 20px;
      box-shadow: 0 4px 10px rgba(0,0,0,0.05); border: 1px solid #eee;
    }
    .order-header { display: flex; justify-content: space-between; border-bottom: 1px solid #eee; padding-bottom: 10px; margin-bottom: 15px; }
    .customer-info h4 { margin: 0; color: #333; }
    .customer-info p { margin: 2px 0; font-size: 13px; color: #666; }

    .status-badge { padding: 5px 12px; border-radius: 20px; font-size: 12px; font-weight: bold; text-transform: uppercase; }
    .status-pending { background: #fff3cd; color: #856404; }
    .status-shipped { background: #d1ecf1; color: #0c5460; }
    .status-delivered { background: #d4edda; color: #155724; }

    /* ITEMS TABLE */
    .items-list { width: 100%; border-collapse: collapse; margin: 15px 0; }
    .items-list th { text-align: left; font-size: 12px; color: #888; padding: 8px; border-bottom: 2px solid #f4f4f4; }
    .items-list td { padding: 10px 8px; font-size: 14px; border-bottom: 1px solid #f9f9f9; }
    .item-img { width: 40px; height: 40px; object-fit: contain; border-radius: 5px; background: #f9f9f9; }

    .order-footer { display: flex; justify-content: space-between; align-items: center; margin-top: 10px; }
    .total-price { font-size: 18px; font-weight: bold; color: var(--primary); }

    /* ACTION BUTTONS */
    .action-btns { display: flex; gap: 10px; }
    .btn { padding: 8px 15px; border-radius: 6px; border: none; cursor: pointer; font-weight: 600; font-size: 13px; transition: 0.3s; }
    .btn-ship { background: var(--primary); color: white; }
    .btn-delete { background: #fff0f0; color: var(--danger); }
    .btn:hover { opacity: 0.8; }

    @media (max-width: 600px) {
      .order-header { flex-direction: column; gap: 10px; }
      .order-footer { flex-direction: column; align-items: flex-start; gap: 15px; }
    }
  </style>
</head>
<body>

<div class="header">
  <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> MS MART Admin</a>
  <h3 style="margin:0;">Manage Orders</h3>
  <div style="width: 20px;"></div>
</div>

<div class="container">
  <div class="page-title">
    <h2>Customer Orders</h2>
    <p id="orderCount">Loading orders...</p>
  </div>

  <div id="ordersContainer">
    <p style="text-align: center; color: #999;">Fetching latest orders...</p>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy, doc, updateDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  // Firebase Config
const firebaseConfig = {
  apiKey: "AIzaSyAb7lILQF-Cd27aKmRJ2mOoEUtiMsYgcww",
  authDomain: "msmart-2ce7c.firebaseapp.com",
  projectId: "msmart-2ce7c",
  storageBucket: "msmart-2ce7c.firebasestorage.app",
  messagingSenderId: "844751147092",
  appId: "1:844751147092:web:89ed978077d83622765dc1",
  measurementId: "G-HXH0HPHE0W"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  // 1. Fetch Orders from Firestore
  async function loadOrders() {
    const container = document.getElementById("ordersContainer");
    const countLabel = document.getElementById("orderCount");
    
    try {
      // ఆర్డర్లను తేదీ ప్రకారం (కొత్తవి పైన) తీసుకురావడం
      const q = query(collection(db, "orders"), orderBy("date", "desc"));
      const querySnapshot = await getDocs(q);
      
      container.innerHTML = "";
      countLabel.innerText = `Total Orders: ${querySnapshot.size}`;

      if (querySnapshot.empty) {
        container.innerHTML = "<p style='text-align:center;'>No orders found yet.</p>";
        return;
      }

      querySnapshot.forEach((docSnap) => {
        const order = docSnap.data();
        const orderId = docSnap.id;

        // ఆర్డర్ లోని ఐటమ్స్ లిస్ట్ తయారు చేయడం
        let itemsRows = "";
        order.items.forEach(item => {
          itemsRows += `
            <tr>
              <td><img src="${item.image}" class="item-img"></td>
              <td>${item.name}</td>
              <td>${item.qty}</td>
              <td>₹${item.price}</td>
            </tr>
          `;
        });

        const card = document.createElement("div");
        card.className = "order-card";
        card.innerHTML = `
          <div class="order-header">
            <div class="customer-info">
              <h4>${order.customerName}</h4>
              <p><i class="fas fa-phone"></i> ${order.mobile}</p>
              <p><i class="fas fa-map-marker-alt"></i> ${order.fullAddress}</p>
              <p><i class="fas fa-clock"></i> Ordered on: ${order.date}</p>
            </div>
            <div>
              <span class="status-badge status-${order.status.toLowerCase()}">${order.status}</span>
            </div>
          </div>

          <table class="items-list">
            <thead>
              <tr>
                <th>Img</th>
                <th>Product</th>
                <th>Qty</th>
                <th>Price</th>
              </tr>
            </thead>
            <tbody>${itemsRows}</tbody>
          </table>

          <div class="order-footer">
            <div class="total-price">Total Amount: ₹${order.totalAmount}</div>
            <div class="action-btns">
              ${order.status === 'Pending' ? `<button class="btn btn-ship" onclick="updateStatus('${orderId}', 'Shipped')">Mark Shipped</button>` : ''}
              ${order.status === 'Shipped' ? `<button class="btn btn-ship" style="background:#28a745" onclick="updateStatus('${orderId}', 'Delivered')">Mark Delivered</button>` : ''}
              <button class="btn btn-delete" onclick="deleteOrder('${orderId}')"><i class="fas fa-trash"></i></button>
            </div>
          </div>
        `;
        container.appendChild(card);
      });

    } catch (error) {
      console.error("Error loading orders:", error);
      container.innerHTML = "<p style='color:red;'>Failed to load orders. Check console.</p>";
    }
  }

  // 2. Status Update Function
  window.updateStatus = async (id, newStatus) => {
    if (confirm(`Change status to ${newStatus}?`)) {
      try {
        await updateDoc(doc(db, "orders", id), { status: newStatus });
        alert("Status Updated!");
        loadOrders();
      } catch (e) { alert("Error: " + e.message); }
    }
  };

  // 3. Delete Order Function
  window.deleteOrder = async (id) => {
    if (confirm("Are you sure you want to delete this order record?")) {
      try {
        await deleteDoc(doc(db, "orders", id));
        alert("Order Deleted!");
        loadOrders();
      } catch (e) { alert("Error: " + e.message); }
    }
  };

  // Initial Load
  loadOrders();

</script>

</body>
</html>