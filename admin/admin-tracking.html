<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Admin - Order Tracking</title>
<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

<style>
  :root { --primary: #0a8; --dark: #111; --gray: #f4f7f9; }
  body { margin: 0; font-family: 'Poppins', sans-serif; background: var(--gray); padding-top: 70px; }

  /* HEADER */
  .header { 
    background: var(--dark); color: #fff; padding: 15px; 
    display: flex; align-items: center; justify-content: space-between;
    position: fixed; top: 0; left: 0; width: 100%; z-index: 1000;
  }
  .back-btn { color: white; text-decoration: none; }

  .container { padding: 20px; max-width: 900px; margin: 0 auto; }
  
  /* TRACKING TABLE */
  .tracking-card {
    background: white; border-radius: 12px; padding: 20px;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05);
  }
  table { width: 100%; border-collapse: collapse; }
  th { text-align: left; padding: 12px; border-bottom: 2px solid #eee; color: #666; font-size: 14px; }
  td { padding: 15px 12px; border-bottom: 1px solid #f4f4f4; font-size: 14px; }

  .order-id { font-weight: bold; color: var(--primary); }
  .customer-name { display: block; font-weight: 600; }
  .mobile { font-size: 12px; color: #888; }

  /* LINK BUTTON */
  .add-link-btn {
    background: #e3f2fd; color: #1976d2; border: none; padding: 8px 12px;
    border-radius: 6px; cursor: pointer; font-size: 12px; font-weight: bold;
    display: flex; align-items: center; gap: 5px; transition: 0.3s;
  }
  .add-link-btn:hover { background: #1976d2; color: white; }
  .has-link { background: #d4edda; color: #155724; }

  /* MODAL FOR LINK INPUT */
  .modal {
    display: none; position: fixed; z-index: 2000; left: 0; top: 0; 
    width: 100%; height: 100%; background: rgba(0,0,0,0.6);
    align-items: center; justify-content: center;
  }
  .modal-content {
    background: white; padding: 25px; border-radius: 15px; width: 90%; max-width: 400px;
    box-shadow: 0 10px 25px rgba(0,0,0,0.2);
  }
  .modal-content h3 { margin-top: 0; }
  .modal-content input {
    width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px;
    box-sizing: border-box; margin: 15px 0;
  }
  .save-btn {
    width: 100%; background: var(--primary); color: white; border: none;
    padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer;
  }

  @media (max-width: 600px) {
    th:nth-child(3), td:nth-child(3) { display: none; } /* Hide Date on mobile */
  }
</style>
</head>

<body>

<div class="header">
  <a href="index.html" class="back-btn"><i class="fas fa-arrow-left"></i> MS MART Admin</a>
  <h3 style="margin:0;">Order Tracking</h3>
  <div style="width: 30px;"></div>
</div>

<div class="container">
  <div class="tracking-card">
    <table id="trackingTable">
      <thead>
        <tr>
          <th>Order / Customer</th>
          <th>Mobile</th>
          <th>Order Date</th>
          <th>Tracking Link</th>
        </tr>
      </thead>
      <tbody id="trackingBody">
        <tr><td colspan="4" style="text-align:center; color:#999;">Loading orders...</td></tr>
      </tbody>
    </table>
  </div>
</div>

<div id="linkModal" class="modal">
  <div class="modal-content">
    <h3>Add Tracking Link</h3>
    <p id="modalCustomer" style="font-size: 13px; color: #666;"></p>
    <input type="text" id="trackUrl" placeholder="https://delivery.com/track/12345">
    <input type="hidden" id="selectedOrderId">
    <button class="save-btn" onclick="saveTracking()">Save & Update User</button>
    <button onclick="closeModal()" style="width:100%; background:none; border:none; color:#999; margin-top:10px; cursor:pointer;">Cancel</button>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, getDocs, query, orderBy, doc, updateDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

  const firebaseConfig = {
  apiKey: "AIzaSyAb7lILQF-Cd27aKmRJ2mOoEUtiMsYgcww",
  authDomain: "msmart-2ce7c.firebaseapp.com",
  projectId: "msmart-2ce7c",
  storageBucket: "msmart-2ce7c.firebasestorage.app",
  messagingSenderId: "844751147092",
  appId: "1:844751147092:web:89ed978077d83622765dc1",
  measurementId: "G-HXH0HPHE0W"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);

  async function loadOrders() {
    const body = document.getElementById("trackingBody");
    try {
      const q = query(collection(db, "orders"), orderBy("date", "desc"));
      const querySnapshot = await getDocs(q);
      body.innerHTML = "";

      if (querySnapshot.empty) {
        body.innerHTML = "<tr><td colspan='4' style='text-align:center;'>No orders found.</td></tr>";
        return;
      }

      querySnapshot.forEach((docSnap) => {
        const order = docSnap.data();
        const id = docSnap.id;
        const hasLink = order.trackingLink ? "has-link" : "";
        const linkIcon = order.trackingLink ? "fa-check-circle" : "fa-plus-circle";
        const btnText = order.trackingLink ? "Update Link" : "Add Link";

        body.innerHTML += `
          <tr>
            <td>
              <span class="customer-name">${order.customerName}</span>
              <span class="order-id">ID: ...${id.slice(-6)}</span>
            </td>
            <td>${order.mobile}</td>
            <td style="color:#888;">${order.date.split(',')[0]}</td>
            <td>
              <button class="add-link-btn ${hasLink}" onclick="openModal('${id}', '${order.customerName}', '${order.trackingLink || ''}')">
                <i class="fas ${linkIcon}"></i> ${btnText}
              </button>
            </td>
          </tr>
        `;
      });
    } catch (e) { console.error(e); }
  }

  window.openModal = (id, name, currentLink) => {
    document.getElementById("linkModal").style.display = "flex";
    document.getElementById("selectedOrderId").value = id;
    document.getElementById("modalCustomer").innerText = "Order for: " + name;
    document.getElementById("trackUrl").value = currentLink;
  };

  window.closeModal = () => { document.getElementById("linkModal").style.display = "none"; };

  window.saveTracking = async () => {
    const id = document.getElementById("selectedOrderId").value;
    const url = document.getElementById("trackUrl").value.trim();

    if(!url) return alert("Please paste the link!");

    try {
      const orderRef = doc(db, "orders", id);
      await updateDoc(orderRef, { trackingLink: url, status: "Shipped" });
      alert("Tracking Link Added & Order Status set to Shipped!");
      closeModal();
      loadOrders();
    } catch (e) { alert(e.message); }
  };

  loadOrders();
</script>

</body>
</html>