<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>MS MART - Admin Products</title>
<style>
  :root { --primary: #0a8; --dark: #111; --gray: #f4f7f9; --danger: #e74c3c; --info: #3498db; }
  body { margin: 0; font-family: 'Segoe UI', Arial, sans-serif; background: var(--gray); }
  
  /* HEADER */
  .header { 
    background: var(--dark); color: #fff; padding: 15px; 
    display: flex; align-items: center; gap: 15px;
    position: sticky; top:0; z-index: 1000;
  }
  .menu-btn { font-size: 24px; cursor: pointer; user-select: none; }
  .back-btn { font-size: 24px; cursor: pointer; color: white; text-decoration: none; }

  /* SIDEBAR */
  .left-menu {
    width: 250px; background: #222; color: white; position: fixed;
    height: 100vh; top: 0; left: -250px; transition: 0.3s;
    padding-top: 60px; z-index: 999; box-shadow: 2px 0 5px rgba(0,0,0,0.5);
  }
  .left-menu.show { left: 0; }
  .left-menu a, .left-menu div {
    text-decoration: none; color: white; display: block;
    padding: 15px 20px; border-bottom: 1px solid #333; transition: 0.2s;
  }
  .left-menu a:hover { background: #333; padding-left: 25px; }
  .logout-btn { background: crimson; text-align: center; cursor: pointer; margin-top: 20px; }

  /* MAIN CONTENT */
  .container { padding: 15px; max-width: 800px; margin: 0 auto; }

  /* PRODUCT CARDS */
  .product-list { display: grid; grid-template-columns: repeat(auto-fill, minmax(160px, 1fr)); gap: 15px; }
  .product-card {
    background: white; border-radius: 12px; overflow: hidden;
    box-shadow: 0 4px 10px rgba(0,0,0,0.05); position: relative;
    display: flex; flex-direction: column; height: 100%;
  }
  .p-img-box { width: 100%; height: 130px; background: #eee; position: relative; }
  .p-img-box img { width: 100%; height: 100%; object-fit: cover; }
  
  /* üî¥ EDIT ICON STYLE */
  .edit-icon {
    position: absolute; top: 8px; right: 8px; background: white;
    color: var(--info); width: 30px; height: 30px; border-radius: 50%;
    display: flex; align-items: center; justify-content: center;
    cursor: pointer; box-shadow: 0 2px 5px rgba(0,0,0,0.2); z-index: 10;
  }

  .p-info { padding: 10px; flex-grow: 1; }
  .p-info h4 { margin: 0 0 5px; font-size: 14px; color: #333; }
  .price-row { display: flex; align-items: center; gap: 8px; margin-bottom: 5px; }
  .current-price { color: var(--primary); font-weight: bold; font-size: 15px; }
  .old-price { color: #999; text-decoration: line-through; font-size: 12px; }
  .p-desc { font-size: 11px; color: #777; margin: 0; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; }

  .remove-btn {
    background: #fff0f0; color: var(--danger); border: none; padding: 8px;
    font-size: 13px; font-weight: 600; cursor: pointer; width: 100%;
    border-top: 1px solid #f0f0f0; transition: 0.3s;
  }
  .remove-btn:hover { background: var(--danger); color: white; }

  .fab {
    position: fixed; bottom: 30px; right: 30px; 
    background: var(--primary); color: white; width: 60px; height: 60px;
    border-radius: 50%; display: flex; align-items: center; justify-content: center;
    font-size: 35px; box-shadow: 0 5px 15px rgba(0,170,136,0.4); cursor: pointer; border: none; z-index: 150;
  }

  /* MODAL */
  .modal {
    display: none; position: fixed; z-index: 2000; left: 0; top: 0; width: 100%; height: 100%;
    background: rgba(0,0,0,0.6); align-items: center; justify-content: center; padding: 10px;
  }
  .modal-content {
    background: white; width: 100%; max-width: 550px; border-radius: 15px;
    padding: 20px; position: relative; animation: slideUp 0.3s ease; box-sizing: border-box;
  }
  @keyframes slideUp { from { transform: translateY(30px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }

  .modal-grid { display: flex; flex-wrap: wrap; gap: 15px; }
  .modal-left { flex: 1; min-width: 150px; }
  .modal-right { flex: 1.5; min-width: 200px; }

  .img-upload {
    width: 100%; height: 160px; border: 2px dashed #ccc; border-radius: 10px;
    display: flex; align-items: center; justify-content: center; overflow: hidden; position: relative;
  }
  .img-upload img { width: 100%; height: 100%; object-fit: cover; }
  .img-upload input { position: absolute; opacity: 0; width: 100%; height: 100%; cursor: pointer; }

  .form-group { margin-bottom: 12px; }
  .form-group label { display: block; font-size: 12px; color: #666; margin-bottom: 4px; font-weight: 600; }
  .form-group input, .form-group textarea { 
    width: 100%; padding: 10px; border: 1px solid #ddd; border-radius: 6px; box-sizing: border-box; font-size: 14px;
  }
  .add-final-btn {
    width: 100%; background: var(--primary); color: white; border: none; padding: 12px;
    font-size: 16px; border-radius: 8px; cursor: pointer; font-weight: bold;
  }
</style>
</head>
<body>

<div class="header">
  <span class="menu-btn" id="toggleBtn">‚ò∞</span>
  <span class="back-btn" onclick="window.history.back()">&#8592;</span>
  <h3 id="pageTitle" style="margin:0; flex-grow: 1;">Products</h3>
</div>

<div id="sideMenu" class="left-menu">
  <a href="index.html">üè† Dashboard</a>
  <a href="admin-offers.html">üè∑ Offers</a>
  <a href="admin-categories.html">‚ûï Categories</a>
  <a href="admin-banner.html">üñº Banner Styles</a>
  <a href="admin-orders.html">üì¶ Orders</a>
  <a href="admin-tracking.html">üöö Tracking</a>
  <div class="logout-btn" id="logoutBtn">Logout</div>
</div>

<div class="container">
  <div class="product-list" id="productList">
    <p style="text-align:center; color:#999; grid-column: 1/-1;">Loading products...</p>
  </div>
</div>

<button class="fab" onclick="openAddModal()">+</button>

<div class="modal" id="productModal">
  <div class="modal-content">
    <h3 id="modalTitle" style="margin: 0 0 15px 0; color: #333;">Add New Product</h3>
    <div class="modal-grid">
      <div class="modal-left">
        <div class="img-upload">
          <img id="preview" src="https://cdn-icons-png.flaticon.com/512/1160/1160358.png">
          <input type="file" id="pFile" accept="image/*">
        </div>
        <p style="font-size: 11px; color: #888; text-align: center; margin-top: 5px;">Click to upload image</p>
      </div>
      <div class="modal-right">
        <div class="form-group">
          <label>Item Name</label>
          <input type="text" id="pName" placeholder="Ex: Tomato 1KG">
        </div>
        <div style="display: flex; gap: 10px;">
          <div class="form-group" style="flex: 1;">
            <label>Old Price (‚Çπ)</label>
            <input type="number" id="pOldPrice" placeholder="100">
          </div>
          <div class="form-group" style="flex: 1;">
            <label>Offer Price (‚Çπ)</label>
            <input type="number" id="pPrice" placeholder="80">
          </div>
        </div>
        <div class="form-group">
          <label>Description</label>
          <textarea id="pDesc" rows="2" placeholder="Product details..."></textarea>
        </div>
        <input type="hidden" id="editId">
        <button class="add-final-btn" id="addBtn">Add Product</button>
        <button onclick="toggleModal(false)" style="width:100%; background:none; border:none; color:#999; margin-top:10px; cursor:pointer; font-size: 14px;">Cancel</button>
      </div>
    </div>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
  import { getFirestore, collection, addDoc, getDocs, deleteDoc, doc, query, where, updateDoc, getDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
  import { getAuth, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

const firebaseConfig = {
  apiKey: "AIzaSyAb7lILQF-Cd27aKmRJ2mOoEUtiMsYgcww",
  authDomain: "msmart-2ce7c.firebaseapp.com",
  projectId: "msmart-2ce7c",
  storageBucket: "msmart-2ce7c.firebasestorage.app",
  messagingSenderId: "844751147092",
  appId: "1:844751147092:web:89ed978077d83622765dc1",
  measurementId: "G-HXH0HPHE0W"
};

  const app = initializeApp(firebaseConfig);
  const db = getFirestore(app);
  const auth = getAuth(app);

  onAuthStateChanged(auth, (user) => {
    if (!user) window.location.href = "admin-login.html";
    else if (user.email !== "msr.subbarao5@gmail.com") {
      signOut(auth); window.location.href = "admin-login.html";
    }
  });

  const urlParams = new URLSearchParams(window.location.search);
  const currentCatId = urlParams.get('catId');
  const currentCatName = urlParams.get('catName');

  if (!currentCatId) {
    alert("Category ID Missing!");
    window.location.href = "admin-categories.html";
  } else {
    document.getElementById("pageTitle").innerText = currentCatName;
  }

  const sideMenu = document.getElementById("sideMenu");
  document.getElementById("toggleBtn").onclick = () => sideMenu.classList.toggle("show");
  
  window.onclick = (e) => {
    if(!e.target.closest('#sideMenu') && !e.target.closest('#toggleBtn')) {
      sideMenu.classList.remove("show");
    }
  };

  document.getElementById("logoutBtn").onclick = () => {
    signOut(auth).then(() => window.location.href = "admin-login.html");
  };

  // üî¥ UPDATED MODAL LOGIC
  window.toggleModal = (show) => { 
    document.getElementById("productModal").style.display = show ? "flex" : "none"; 
  };

  window.openAddModal = () => {
    document.getElementById("modalTitle").innerText = "Add New Product";
    document.getElementById("addBtn").innerText = "Add Product";
    document.getElementById("editId").value = ""; // Clear ID
    document.getElementById("pName").value = "";
    document.getElementById("pPrice").value = "";
    document.getElementById("pOldPrice").value = "";
    document.getElementById("pDesc").value = "";
    document.getElementById("preview").src = "https://cdn-icons-png.flaticon.com/512/1160/1160358.png";
    toggleModal(true);
  };

  const pFile = document.getElementById("pFile");
  pFile.onchange = () => {
    const [file] = pFile.files;
    if (file) {
      const reader = new FileReader();
      reader.onload = (e) => document.getElementById("preview").src = e.target.result;
      reader.readAsDataURL(file);
    }
  };

  const addBtn = document.getElementById("addBtn");
  addBtn.onclick = async () => {
    const name = document.getElementById("pName").value.trim();
    const price = document.getElementById("pPrice").value.trim();
    const oldPrice = document.getElementById("pOldPrice").value.trim();
    const desc = document.getElementById("pDesc").value.trim();
    const editId = document.getElementById("editId").value;
    const file = pFile.files[0];
    const previewImg = document.getElementById("preview").src;

    if (!name || !price) return alert("Fill mandatory fields");
    
    addBtn.innerText = editId ? "Updating..." : "Adding..."; 
    addBtn.disabled = true;

    try {
        const productData = { 
            name, 
            price, 
            oldPrice, 
            desc, 
            image: previewImg, // We use the current preview src (Base64 or URL)
            categoryId: currentCatId, 
            date: new Date() 
        };

        if (editId) {
            // üî¥ UPDATE LOGIC
            await updateDoc(doc(db, "products", editId), productData);
            alert("Product updated!");
        } else {
            // üü¢ ADD LOGIC
            await addDoc(collection(db, "products"), productData);
            alert("Product added!");
        }
        location.reload();
    } catch(err) { 
        alert(err.message); 
        addBtn.disabled = false; 
    }
  };

  async function loadProducts() {
    const listDiv = document.getElementById("productList");
    try {
      const q = query(collection(db, "products"), where("categoryId", "==", currentCatId));
      const querySnapshot = await getDocs(q);
      listDiv.innerHTML = "";
      if (querySnapshot.empty) {
        listDiv.innerHTML = "<p style='text-align:center; color:#999; grid-column:1/-1;'>No products found.</p>";
        return;
      }
      querySnapshot.forEach((docSnap) => {
        const data = docSnap.data();
        const div = document.createElement("div");
        div.className = "product-card";
        div.innerHTML = `
          <div class="p-img-box">
            <div class="edit-icon" onclick="editProduct('${docSnap.id}')">
                <i class="fas fa-pencil-alt"></i>
            </div>
            <img src="${data.image}">
          </div>
          <div class="p-info">
            <h4>${data.name}</h4>
            <div class="price-row">
              <span class="current-price">‚Çπ${data.price}</span>
              ${data.oldPrice ? `<span class="old-price">‚Çπ${data.oldPrice}</span>` : ''}
            </div>
            <p class="p-desc">${data.desc || ''}</p>
          </div>
          <button class="remove-btn" onclick="deleteProduct('${docSnap.id}')">Remove Item</button>
        `;
        listDiv.appendChild(div);
      });
    } catch (e) { console.error(e); }
  }

  // üî¥ EDIT FUNCTION
  window.editProduct = async (id) => {
    try {
        const docSnap = await getDoc(doc(db, "products", id));
        if (docSnap.exists()) {
            const data = docSnap.data();
            document.getElementById("modalTitle").innerText = "Edit Product";
            document.getElementById("addBtn").innerText = "Update Product";
            document.getElementById("editId").value = id;
            document.getElementById("pName").value = data.name;
            document.getElementById("pPrice").value = data.price;
            document.getElementById("pOldPrice").value = data.oldPrice || "";
            document.getElementById("pDesc").value = data.desc || "";
            document.getElementById("preview").src = data.image;
            toggleModal(true);
        }
    } catch (e) { alert("Error fetching data"); }
  };

  window.deleteProduct = async (id) => {
    if(confirm("Remove this product?")) {
      await deleteDoc(doc(db, "products", id));
      location.reload();
    }
  };

  loadProducts();
</script>

<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css">

</body>
</html>