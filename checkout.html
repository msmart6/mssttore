<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Checkout - MS MART</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"/>

  <style>
    /* üî¥ GLOBAL STYLES */
    body { 
        margin: 0; 
        font-family: 'Poppins', sans-serif; 
        background: #F4F7F9; 
        padding-top: 70px; /* Header Space */
    }
    
    /* üî¥ FIXED TOP BAR */
    .topbar {
      background: #0dbefd; padding: 0 15px; color: #fff;
      display: flex; align-items: center; justify-content: space-between;
      position: fixed; top: 0; left: 0; width: 100%; height: 65px;
      z-index: 1000; box-shadow: 0 2px 10px rgba(0,0,0,0.3);
      box-sizing: border-box;
    }
    .menu-icon { font-size: 24px; cursor: pointer; margin-right: 10px; position: relative; z-index: 1001; }

    .logo-container {
        display: flex;
        align-items: center;
        text-decoration: none;
        position: absolute; 
        left: 50px;
        top: 50%;
        transform: translateY(-50%);
        z-index: 1002;
    }
    .logo-img { height: 70px; width: auto; object-fit: contain; }
    
    .top-right { display: flex; align-items: center; gap: 15px; }

    .login-btn {
        color: white;
        text-decoration: none;
        font-size: 13px;
        font-weight: 600;
        border: 1px solid rgba(255,255,255,0.6);
        padding: 5px 15px;
        border-radius: 20px;
        transition: 0.3s;
    }
    .login-btn:hover { background: white; color: #111; border-color: white; }

    /* üî¥ SIDE MENU */
    .sidenav {
      height: 100%; width: 0; position: fixed; z-index: 2000;
      top: 0; left: 0; background-color: #111;
      overflow-x: hidden; transition: 0.3s; padding-top: 60px;
      box-shadow: 2px 0 5px rgba(0,0,0,0.5);
    }
    .sidenav a {
      padding: 10px 15px 10px 32px; text-decoration: none;
      font-size: 16px; color: #ccc; display: block; transition: 0.3s;
      border-bottom: 1px solid #222;
    }
    .sidenav a:hover { color: #fff; background: #0a8; }
    .closebtn { position: absolute; top: 0; right: 25px; font-size: 36px; border:none !important; background: transparent; color: white; cursor: pointer; }

    .cart-badge { position: absolute; top: -8px; right: -10px; background: red; color: white; font-size: 10px; padding: 2px 5px; border-radius: 50%; font-weight: bold; display: none; }

    /* --- CHECKOUT SPECIFIC STYLES --- */
    .container { max-width: 600px; margin: 0 auto; padding: 20px; min-height: 80vh; }
    .summary-card { background: #fff; padding: 15px; border-radius: 12px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); margin-bottom: 20px; }
    .summary-row { display: flex; justify-content: space-between; margin-bottom: 10px; color: #555; }
    .total-row { display: flex; justify-content: space-between; font-size: 20px; font-weight: bold; color: #0a8; border-top: 1px dashed #ddd; padding-top: 10px; margin-top: 10px; }
    
    .input-group { margin-bottom: 15px; }
    .label { font-size: 13px; font-weight: 600; color: #333; margin-bottom: 5px; display: block; }
    .input-field { width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; background: white; font-family: 'Poppins'; }
    .locked-field { background-color: #f9f9f9; color: #555; cursor: not-allowed; }

    .row-2 { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
    .mobile-row { display: flex; gap: 10px; }
    .country-select { width: 110px; padding: 12px; border: 1px solid #ddd; border-radius: 8px; background: white; font-size: 12px; cursor: pointer; }

    .pay-btn { width: 100%; background: #0a8; color: white; border: none; padding: 14px; border-radius: 8px; font-size: 16px; font-weight: bold; cursor: pointer; margin-top: 10px; }

    .qr-container { display: none; text-align: center; background: white; padding: 20px; border-radius: 10px; margin-top: 20px; border: 2px dashed #0a8; }
    .qr-container img { width: 180px; height: 180px; margin-bottom: 10px; }
    .done-btn { background: #111; color: white; padding: 10px 20px; border: none; border-radius: 5px; cursor: pointer; margin-top: 10px; }
    .loading-text { font-size: 12px; color: #0a8; display: none; }

    .site-footer { background-color: #111; color: #fff; padding: 40px 20px 20px; margin-top: 50px; text-align: center; }
    .footer-links { list-style: none; padding: 0; margin: 25px 0; display: flex; flex-wrap: wrap; justify-content: center; gap: 20px; }
    .footer-links li a { color: #ddd; text-decoration: none; font-size: 14px; }
  </style>
</head>

<body>

  <div id="mySidenav" class="sidenav">
    <a href="javascript:void(0)" class="closebtn" onclick="closeNav()">&times;</a>
    <h3 style="color:white; padding-left:30px; margin-bottom: 20px;">MS MART</h3>
    <a href="index.html">üè† Home</a>
    <a href="my-orders.html">üì¶ My Orders</a>
    <a href="cart.html">üõí Cart</a>
    <a href="contact.html">üìû Contact Us</a>
    <a href="about.html">‚ÑπÔ∏è About Us</a>
    <a href="terms.html">üìÑ Terms & Conditions</a>
    <a href="refund.html">üí∏ Refund Policy</a>
  </div>

  <div class="topbar">
    <div style="display:flex; align-items:center;">
        <span class="menu-icon" onclick="openNav()">&#9776;</span>
        <a href="index.html" class="logo-container">
            <img src="images/logo.png" alt="Logo" class="logo-img" onerror="this.src='https://via.placeholder.com/50?text=Logo'">
        </a>
    </div>
    <div class="top-right">
      <a href="login.html" class="login-btn">Login</a> 
      <a href="cart.html" class="icon-btn" style="position: relative; color: white;">
          <i class="fas fa-shopping-cart"></i>
          <span id="cartCountBadge" class="cart-badge">0</span>
      </a> 
    </div>
  </div>

  <div class="container">
    <div style="margin-bottom: 20px;">
        <a href="cart.html" style="text-decoration:none; color:#333; font-weight:bold; font-size:18px;">&#8592; Back to Cart</a>
    </div>

    <div class="summary-card">
        <h3 style="margin-top:0;">Order Summary</h3>
        <div class="summary-row">
            <span>Total Items:</span>
            <span id="totalItems">0</span>
        </div>
        <div class="total-row">
            <span>To Pay:</span>
            <span id="grandTotal">Loading...</span>
        </div>
    </div>

    <div id="qrBox" class="qr-container">
        <h3>Scan to Pay</h3>
        <img id="qrImage" src="" alt="QR Code">
        <p class="qr-note">Open PhonePe/GPay & Scan this QR</p>
        <button class="done-btn" onclick="window.location.href='index.html'">I Have Paid (Go Home)</button>
    </div>

    <div id="checkoutForm">
        <h3>Shipping Details</h3>
        <div class="input-group">
            <label class="label">Full Name</label>
            <input type="text" id="name" class="input-field" placeholder="Enter Full Name">
        </div>
        <div class="input-group">
            <label class="label">Mobile Number</label>
            <div class="mobile-row">
                <select id="countryCode" class="country-select">
                    </select>
                <input type="tel" id="mobile" class="input-field" placeholder="10 Digit Number" maxlength="10">
            </div>
        </div>
        <div class="input-group">
            <label class="label">Pincode (Auto-fills City/State)</label>
            <input type="tel" id="pincode" class="input-field" placeholder="Ex: 534001" maxlength="6">
            <span id="pincodeMsg" class="loading-text">Fetching Location...</span>
        </div>
        <div class="row-2 input-group">
            <div><label class="label">City / Village</label><input type="text" id="city" class="input-field locked-field" placeholder="City" readonly></div>
            <div><label class="label">State</label><input type="text" id="state" class="input-field locked-field" placeholder="State" readonly></div>
        </div>
        <div class="input-group">
            <label class="label">Country</label>
            <input type="text" id="country" class="input-field locked-field" value="India" readonly>
        </div>
        <div class="input-group">
            <label class="label">Full Address (House No, Street, Landmark)</label>
            <input type="text" id="address" class="input-field" placeholder="Enter Address">
        </div>
        <button class="pay-btn" id="placeOrderBtn">Proceed to Pay</button>
    </div>
  </div>

  <footer class="site-footer">
    <div class="footer-content">
        <img src="images/logo.png" alt="Logo" class="footer-logo-img" onerror="this.style.display='none'">
        <p>Best Quality, Best Price, Fast Delivery.</p>
        <ul class="footer-links">
            <li><a href="index.html">Home</a></li>
            <li><a href="about.html">About Us</a></li>
            <li><a href="contact.html">Contact Us</a></li>
            <li><a href="terms.html">Terms</a></li>
            <li><a href="refund.html">Refund Policy</a></li>
        </ul>
    </div>
    <div class="footer-bottom">
        <p>&copy; 2025 MS MART. All Rights Reserved.</p>
    </div>
  </footer>

  <script>
    function openNav() { document.getElementById("mySidenav").style.width = "250px"; }
    function closeNav() { document.getElementById("mySidenav").style.width = "0"; }
    
    // Country List Logic (25 Countries)
    const countries = [
        {name: "India", code: "+91"}, {name: "USA", code: "+1"}, {name: "UK", code: "+44"},
        {name: "UAE", code: "+971"}, {name: "Australia", code: "+61"}, {name: "Canada", code: "+1"},
        {name: "Singapore", code: "+65"}, {name: "Germany", code: "+49"}, {name: "France", code: "+33"},
        {name: "Japan", code: "+81"}, {name: "China", code: "+86"}, {name: "Italy", code: "+39"},
        {name: "Brazil", code: "+55"}, {name: "Russia", code: "+7"}, {name: "South Africa", code: "+27"},
        {name: "Kuwait", code: "+965"}, {name: "Qatar", code: "+974"}, {name: "Saudi Arabia", code: "+966"},
        {name: "Malaysia", code: "+60"}, {name: "Thailand", code: "+66"}, {name: "Sri Lanka", code: "+94"},
        {name: "Nepal", code: "+977"}, {name: "Bangladesh", code: "+880"}, {name: "Netherlands", code: "+31"},
        {name: "Mexico", code: "+52"}
    ];
    const countryDropdown = document.getElementById("countryCode");
    countries.forEach(c => {
        let opt = document.createElement("option");
        opt.value = c.code;
        opt.innerText = `${c.name} (${c.code})`;
        if(c.name === "India") opt.selected = true;
        countryDropdown.appendChild(opt);
    });

    let cart = JSON.parse(localStorage.getItem('ms_cart')) || [];
    let totalCount = cart.reduce((sum, item) => sum + item.qty, 0);
    const badge = document.getElementById("cartCountBadge");
    if(badge) { badge.innerText = totalCount; badge.style.display = totalCount > 0 ? "block" : "none"; }
  </script>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, collection, addDoc } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";
    import { getAuth, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-auth.js";

    const firebaseConfig = {
        apiKey: "AIzaSyAb7lILQF-Cd27aKmRJ2mOoEUtiMsYgcww",
        authDomain: "msmart-2ce7c.firebaseapp.com",
        projectId: "msmart-2ce7c",
        storageBucket: "msmart-2ce7c.firebasestorage.app",
        messagingSenderId: "844751147092",
        appId: "1:844751147092:web:89ed978077d83622765dc1",
        measurementId: "G-HXH0HPHE0W"
    };

    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    const auth = getAuth(app);

    let currentUser = null;

    onAuthStateChanged(auth, (user) => {
        if (user) {
            currentUser = user;
        } else {
            alert("Please login to continue checkout.");
            window.location.href = "login.html";
        }
    });

    // Pincode Logic
    document.getElementById("pincode").addEventListener("input", async function() {
        if(this.value.length === 6) {
            document.getElementById("pincodeMsg").style.display = "block"; 
            try {
                const res = await fetch(`https://api.postalpincode.in/pincode/${this.value}`);
                const data = await res.json();
                if (data[0].Status === "Success") {
                    const details = data[0].PostOffice[0];
                    document.getElementById("city").value = details.Block || details.Name; 
                    document.getElementById("state").value = details.State;
                }
            } catch (e) { console.error(e); }
            document.getElementById("pincodeMsg").style.display = "none"; 
        }
    });

    // Pricing
    function parseCurrency(value) {
        let str = String(value).replace(/[^0-9.]/g, ''); 
        return parseFloat(str) || 0;
    }

    let finalAmount = 0;
    let cartData = JSON.parse(localStorage.getItem('ms_cart')) || [];
    cartData.forEach(item => {
        let p = parseCurrency(item.price);
        let q = parseCurrency(item.qty) || 1;
        finalAmount += (p * q);
    });

    if (finalAmount < 1499 && finalAmount > 0) finalAmount += 89;
    document.getElementById("totalItems").innerText = cartData.length;
    document.getElementById("grandTotal").innerText = "‚Çπ" + finalAmount;

    // Place Order
    document.getElementById("placeOrderBtn").onclick = async () => {
        if (!currentUser) return alert("Login required!");

        const name = document.getElementById("name").value;
        const mobile = document.getElementById("mobile").value;
        const address = document.getElementById("address").value;
        const city = document.getElementById("city").value;
        const state = document.getElementById("state").value;
        const pincode = document.getElementById("pincode").value;

        if(!name || !mobile || !address || !city || !pincode) { 
            alert("Please fill all shipping details!"); 
            return; 
        }

        const btn = document.getElementById("placeOrderBtn");
        btn.innerText = "Saving Order..."; 
        btn.disabled = true;

        try {
            await addDoc(collection(db, "orders"), {
                userId: currentUser.uid, // ‡∞ï‡±ç‡∞∞‡∞Æ‡∞Ç‡∞ó‡∞æ ‡∞Ø‡∞æ‡∞°‡±ç ‡∞ö‡±á‡∞Ø‡∞¨‡∞°‡∞ø‡∞Ç‡∞¶‡∞ø
                customerName: name,
                customerEmail: currentUser.email,
                mobile: document.getElementById("countryCode").value + " " + mobile,
                fullAddress: `${address}, ${city}, ${state}, India - ${pincode}`,
                items: cartData,
                totalAmount: finalAmount,
                status: "Pending",
                date: new Date().toISOString()
            });

            const upiLink = `upi://pay?pa=9618341676@ybl&pn=MS_MART&am=${finalAmount}&cu=INR`;
            const isMobile = /Android|iPhone/i.test(navigator.userAgent);
            localStorage.removeItem("ms_cart");

            if (isMobile) {
                window.location.href = upiLink;
                setTimeout(() => { window.location.href = "index.html"; }, 3000);
            } else {
                document.getElementById("checkoutForm").style.display = "none"; 
                document.getElementById("qrBox").style.display = "block"; 
                document.getElementById("qrImage").src = `https://api.qrserver.com/v1/create-qr-code/?size=200x200&data=${encodeURIComponent(upiLink)}`;
            }
        } catch (error) { 
            console.error("Firestore Error:", error);
            alert("Error: " + error.message); 
            btn.disabled = false; 
            btn.innerText = "Proceed to Pay";
        }
    };
</script>
</body>
</html>